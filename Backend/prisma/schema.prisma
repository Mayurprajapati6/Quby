// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  CUSTOMER
  STAFF
  OWNER
  ADMIN
}

enum BusinessType {
  SALON
}

enum ServiceFor {
  MEN
  UNISEX
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum BookingStatus {
  PENDING_PAYMENT
  CONFIRMED
  CHECKED_IN
  IN_PROGRESS
  COMPLETED
  CANCELLED
  CANCELLED_TIMEOUT
  CANCELLED_NO_SHOW
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum EscrowStatus {
  HELD
  RELEASED
  REFUNDED
}

enum RefundStatus {
  PROCESSING
  SUCCESS
  FAILED
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  HALF_DAY
  LEAVE
  HOLIDAY
}

enum BookingEventType {
  BOOKING_CREATED
  PAYMENT_INITIATED
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  BOOKING_CONFIRMED
  CUSTOMER_REMINDED
  CUSTOMER_CHECKED_IN
  SERVICE_STARTED
  SERVICE_COMPLETED
  SERVICE_DELAYED
  BOOKING_CANCELLED
  BOOKING_NO_SHOW
  MONEY_RELEASED
  REFUND_PROCESSED
}

enum CustomerNotificationType {
  BOOKING_CREATED
  BOOKING_CONFIRMED
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  REMINDER_1_HOUR
  REMINDER_15_MIN
  YOUR_TURN_SOON
  SERVICE_READY
  SERVICE_COMPLETED
  SERVICE_DELAYED
  BOOKING_CANCELLED
  REFUND_PROCESSED
  REVIEW_REQUEST
  EARLY_SLOT_AVAILABLE
}

enum BusinessNotificationType {
  NEW_BOOKING
  BOOKING_CANCELLED
  STAFF_LEAVE_REQUEST
  NEW_REVIEW
  PAYMENT_RECEIVED
  LOW_RATING_ALERT
  BUSINESS_VERIFIED
  BUSINESS_REJECTED
  SERVICE_DELAYED
  CUSTOMER_NO_SHOW
}

enum StaffNotificationType {
  NEW_BOOKING
  BOOKING_CANCELLED
  CUSTOMER_CHECKED_IN
  NEXT_CUSTOMER_READY
  LEAVE_APPROVED
  LEAVE_REJECTED
  NEW_REVIEW
  DAILY_SUMMARY
  PERFORMANCE_UPDATE
}

enum WalletTransactionType {
  BOOKING_PAYMENT
  REFUND
  CREDIT
}

enum BusinessWalletTransactionType {
  ESCROW_RELEASE
  PLATFORM_FEE
  WITHDRAWAL
  REFUND_DEDUCTION
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique @db.VarChar(255)
  password_hash String?  @db.VarChar(255)
  role          UserRole @default(CUSTOMER)

  is_active         Boolean   @default(true)
  is_verified       Boolean   @default(false)
  email_verified_at DateTime? @db.Timestamptz(3)

  version Int @default(1)

  created_at    DateTime  @default(now()) @db.Timestamptz(3)
  updated_at    DateTime  @updatedAt @db.Timestamptz(3)
  last_login_at DateTime? @db.Timestamptz(3)

  customer_profile Customer?
  owner_profile    Owner?
  staff_profile    Staff?
  admin_profile    Admin?

  refresh_tokens            RefreshToken[]
  password_reset_tokens     PasswordResetToken[]
  email_verification_tokens EmailVerificationToken[]

  @@index([email])
  @@index([role, is_active])
  @@map("users")
}

model RefreshToken {
  id         String    @id @default(uuid())
  user_id    String
  token      String    @unique @db.VarChar(500)
  expires_at DateTime  @db.Timestamptz(3)
  is_used    Boolean   @default(false)
  used_at    DateTime? @db.Timestamptz(3)
  is_revoked Boolean   @default(false)
  revoked_at DateTime? @db.Timestamptz(3)
  ip_address String?   @db.VarChar(45)
  user_agent String?   @db.Text
  created_at DateTime  @default(now()) @db.Timestamptz(3)

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([token])
  @@index([expires_at])
  @@map("refresh_tokens")
}

model PasswordResetToken {
  id         String    @id @default(uuid())
  user_id    String
  token      String    @unique @db.VarChar(255)
  expires_at DateTime  @db.Timestamptz(3)
  is_used    Boolean   @default(false)
  used_at    DateTime? @db.Timestamptz(3)
  created_at DateTime  @default(now()) @db.Timestamptz(3)

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([token])
  @@map("password_reset_tokens")
}

model EmailVerificationToken {
  id         String    @id @default(uuid())
  user_id    String
  token      String    @unique @db.VarChar(255)
  expires_at DateTime  @db.Timestamptz(3)
  is_used    Boolean   @default(false)
  used_at    DateTime? @db.Timestamptz(3)
  created_at DateTime  @default(now()) @db.Timestamptz(3)

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([token])
  @@map("email_verification_tokens")
}

model Customer {
  id      String @id @default(uuid())
  user_id String @unique

  name       String  @db.VarChar(100)
  phone      String? @db.VarChar(20)
  avatar_url String? @db.VarChar(500)
  gender     String? @db.VarChar(20)

  city    String @db.VarChar(100)
  state   String @db.VarChar(100)
  country String @default("India") @db.VarChar(100)

  address_line1 String? @db.VarChar(255)
  address_line2 String? @db.VarChar(255)

  total_bookings     Int @default(0)
  completed_bookings Int @default(0)
  cancelled_bookings Int @default(0)
  total_spent        Int @default(0)

  current_streak    Int       @default(0)
  longest_streak    Int       @default(0)
  last_booking_date DateTime? @db.Timestamptz(3)

  created_at DateTime @default(now()) @db.Timestamptz(3)
  updated_at DateTime @updatedAt @db.Timestamptz(3)

  user          User                   @relation(fields: [user_id], references: [id], onDelete: Cascade)
  bookings      Booking[]
  reviews       Review[]
  wallet        CustomerWallet?
  notifications CustomerNotification[]
  transactions  Transaction[]
  favourites    CustomerFavourite[]

  @@index([user_id])
  @@index([city, state])
  @@index([phone])
  @@map("customers")
}

model CustomerFavourite {
  id          String @id @default(uuid())
  customer_id String
  business_id String

  created_at DateTime @default(now()) @db.Timestamptz(3)

  customer Customer @relation(fields: [customer_id], references: [id], onDelete: Cascade)
  business Business @relation(fields: [business_id], references: [id], onDelete: Cascade)

  @@unique([customer_id, business_id])
  @@index([customer_id])
  @@map("customer_favourites")
}

model CustomerWallet {
  id          String @id @default(uuid())
  customer_id String @unique

  balance  Int    @default(0)
  currency String @default("INR") @db.VarChar(3)

  lifetime_spent   Int @default(0)
  lifetime_refunds Int @default(0)

  created_at DateTime @default(now()) @db.Timestamptz(3)
  updated_at DateTime @updatedAt @db.Timestamptz(3)

  customer     Customer                    @relation(fields: [customer_id], references: [id], onDelete: Cascade)
  transactions CustomerWalletTransaction[]

  @@index([customer_id])
  @@map("customer_wallets")
}

model CustomerWalletTransaction {
  id        String @id @default(uuid())
  wallet_id String

  type          WalletTransactionType
  amount        Int
  balance_after Int

  booking_id     String?
  transaction_id String?

  description String @db.VarChar(255)
  metadata    Json?  @db.JsonB

  created_at DateTime @default(now()) @db.Timestamptz(3)

  wallet CustomerWallet @relation(fields: [wallet_id], references: [id], onDelete: Cascade)

  @@index([wallet_id, created_at])
  @@index([booking_id])
  @@map("customer_wallet_transactions")
}

model CustomerNotification {
  id          String @id @default(uuid())
  customer_id String

  type    CustomerNotificationType
  title   String                   @db.VarChar(200)
  message String                   @db.Text

  data       Json?   @db.JsonB
  action_url String? @db.VarChar(500)

  is_read Boolean   @default(false)
  read_at DateTime? @db.Timestamptz(3)

  created_at DateTime @default(now()) @db.Timestamptz(3)

  customer Customer @relation(fields: [customer_id], references: [id], onDelete: Cascade)

  @@index([customer_id, created_at])
  @@index([customer_id, is_read])
  @@map("customer_notifications")
}

model Owner {
  id      String @id @default(uuid())
  user_id String @unique

  name       String  @db.VarChar(100)
  phone      String  @db.VarChar(20)
  avatar_url String? @db.VarChar(500)

  city  String @db.VarChar(100)
  state String @db.VarChar(100)

  total_businesses  Int @default(0)
  active_businesses Int @default(0)
  total_staff       Int @default(0)
  total_bookings    Int @default(0)
  lifetime_earnings Int @default(0)
  current_balance   Int @default(0)

  is_verified Boolean   @default(false)
  verified_at DateTime? @db.Timestamptz(3)

  created_at DateTime @default(now()) @db.Timestamptz(3)
  updated_at DateTime @updatedAt @db.Timestamptz(3)

  user       User       @relation(fields: [user_id], references: [id], onDelete: Cascade)
  businesses Business[]

  @@index([user_id])
  @@index([phone])
  @@map("owners")
}

model Business {
  id       String @id @default(uuid())
  owner_id String

  business_name String       @db.VarChar(200)
  slug          String       @unique @db.VarChar(255)
  business_type BusinessType
  service_for   ServiceFor
  description   String?      @db.Text

  address_line1 String  @db.VarChar(255)
  address_line2 String? @db.VarChar(255)
  city          String  @db.VarChar(100)
  state         String  @db.VarChar(100)
  pincode       String  @db.VarChar(10)
  country       String  @default("India") @db.VarChar(100)
  latitude      Float?
  longitude     Float?

  business_email String? @db.VarChar(255)
  business_phone String? @db.VarChar(20)
  website_url    String? @db.VarChar(500)

  logo_url        String? @db.VarChar(500)
  cover_image_url String? @db.VarChar(500)

  is_verified       Boolean   @default(false)
  verified_at       DateTime? @db.Timestamptz(3)
  verification_note String?   @db.Text

  is_active Boolean @default(true)

  break_time_minutes Int @default(5)

  average_rating Float? @default(0)
  total_reviews  Int    @default(0)

  created_at DateTime @default(now()) @db.Timestamptz(3)
  updated_at DateTime @updatedAt @db.Timestamptz(3)

  owner         Owner                     @relation(fields: [owner_id], references: [id], onDelete: Cascade)
  staff         Staff[]
  services      BusinessServiceOffering[]
  bookings      Booking[]
  reviews       Review[]
  wallet        BusinessWallet?
  schedules     BusinessSchedule[]
  holidays      Holiday[]
  images        BusinessImage[]
  notifications BusinessNotification[]
  favourites    CustomerFavourite[]

  @@index([owner_id])
  @@index([slug])
  @@index([city, state])
  @@index([business_type, service_for])
  @@index([is_verified, is_active])
  @@index([latitude, longitude])
  @@map("businesses")
}

model BusinessSchedule {
  id          String @id @default(uuid())
  business_id String

  day_of_week DayOfWeek
  is_open     Boolean   @default(true)

  open_time  String?  @db.VarChar(5)
  close_time String?  @db.VarChar(5)
  created_at DateTime @default(now()) @db.Timestamptz(3)
  updated_at DateTime @updatedAt @db.Timestamptz(3)

  business Business @relation(fields: [business_id], references: [id], onDelete: Cascade)

  @@unique([business_id, day_of_week])
  @@index([business_id])
  @@map("business_schedules")
}

model BusinessImage {
  id          String @id @default(uuid())
  business_id String

  image_url     String  @db.VarChar(500)
  public_id     String? @db.VarChar(255)
  thumbnail_url String? @db.VarChar(500)
  medium_url    String? @db.VarChar(500)

  is_primary Boolean @default(false)
  sort_order Int     @default(0)
  caption    String? @db.VarChar(255)

  created_at DateTime @default(now()) @db.Timestamptz(3)

  business Business @relation(fields: [business_id], references: [id], onDelete: Cascade)

  @@index([business_id])
  @@index([is_primary])
  @@map("business_images")
}

model BusinessNotification {
  id          String @id @default(uuid())
  business_id String

  type    BusinessNotificationType
  title   String                   @db.VarChar(200)
  message String                   @db.Text

  data       Json?   @db.JsonB
  action_url String? @db.VarChar(500)

  is_read Boolean   @default(false)
  read_at DateTime? @db.Timestamptz(3)

  created_at DateTime @default(now()) @db.Timestamptz(3)

  business Business @relation(fields: [business_id], references: [id], onDelete: Cascade)

  @@index([business_id, created_at])
  @@index([business_id, is_read])
  @@map("business_notifications")
}

model BusinessWallet {
  id          String @id @default(uuid())
  business_id String @unique

  balance           Int    @default(0)
  currency          String @default("INR") @db.VarChar(3)
  lifetime_earnings Int    @default(0)

  version Int @default(1)

  created_at DateTime @default(now()) @db.Timestamptz(3)
  updated_at DateTime @updatedAt @db.Timestamptz(3)

  business     Business                    @relation(fields: [business_id], references: [id], onDelete: Cascade)
  transactions BusinessWalletTransaction[]

  @@index([business_id])
  @@map("business_wallets")
}

model BusinessWalletTransaction {
  id        String @id @default(uuid())
  wallet_id String

  type          BusinessWalletTransactionType
  amount        Int
  balance_after Int

  booking_id String?
  escrow_id  String?

  description String @db.VarChar(255)
  metadata    Json?  @db.JsonB

  created_at DateTime @default(now()) @db.Timestamptz(3)

  wallet BusinessWallet @relation(fields: [wallet_id], references: [id], onDelete: Cascade)

  @@index([wallet_id, created_at])
  @@index([booking_id])
  @@map("business_wallet_transactions")
}

model Holiday {
  id          String @id @default(uuid())
  business_id String

  holiday_name String  @db.VarChar(100)
  description  String? @db.Text

  start_date DateTime @db.Date
  end_date   DateTime @db.Date

  applies_to_all_staff Boolean @default(true)

  created_at DateTime @default(now()) @db.Timestamptz(3)

  business       Business       @relation(fields: [business_id], references: [id], onDelete: Cascade)
  staff_holidays StaffHoliday[]

  @@index([business_id, start_date, end_date])
  @@map("holidays")
}

model StaffHoliday {
  id         String @id @default(uuid())
  holiday_id String
  staff_id   String

  created_at DateTime @default(now()) @db.Timestamptz(3)

  holiday Holiday @relation(fields: [holiday_id], references: [id], onDelete: Cascade)
  staff   Staff   @relation(fields: [staff_id], references: [id], onDelete: Cascade)

  @@unique([holiday_id, staff_id])
  @@map("staff_holidays")
}

model Staff {
  id          String @id @default(uuid())
  user_id     String @unique
  business_id String

  name       String  @db.VarChar(100)
  phone      String  @db.VarChar(20)
  email      String  @db.VarChar(255)
  avatar_url String? @db.VarChar(500)

  bio              String? @db.Text
  specialization   String? @db.VarChar(200)
  experience_years Int?

  is_active   Boolean @default(true)
  is_verified Boolean @default(false)

  average_rating Float? @default(0)
  total_reviews  Int    @default(0)

  current_service_streak Int       @default(0)
  longest_service_streak Int       @default(0)
  last_service_date      DateTime? @db.Timestamptz(3)

  created_at DateTime @default(now()) @db.Timestamptz(3)
  updated_at DateTime @updatedAt @db.Timestamptz(3)

  user     User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  business Business @relation(fields: [business_id], references: [id], onDelete: Cascade)

  bookings       Booking[]
  schedules      StaffSchedule[]
  leaves         StaffLeave[]
  queues         DailyQueue[]
  services       StaffService[]
  reviews        Review[]
  staff_holidays StaffHoliday[]
  notifications  StaffNotification[]
  attendance     StaffAttendance[]
  performance    StaffPerformance[]

  @@index([user_id])
  @@index([business_id])
  @@index([business_id, is_active])
  @@index([email])
  @@index([phone])
  @@map("staff")
}

model StaffSchedule {
  id       String @id @default(uuid())
  staff_id String

  day_of_week  DayOfWeek
  is_available Boolean   @default(true)

  start_time String? @db.VarChar(5)
  end_time   String? @db.VarChar(5)

  created_at DateTime @default(now()) @db.Timestamptz(3)
  updated_at DateTime @updatedAt @db.Timestamptz(3)

  staff Staff @relation(fields: [staff_id], references: [id], onDelete: Cascade)

  @@unique([staff_id, day_of_week])
  @@index([staff_id])
  @@map("staff_schedules")
}

model StaffLeave {
  id       String @id @default(uuid())
  staff_id String

  start_date DateTime @db.Date
  end_date   DateTime @db.Date

  reason     String @db.Text
  leave_type String @db.VarChar(50)

  status LeaveStatus @default(PENDING)

  approved_by      String?
  approved_at      DateTime? @db.Timestamptz(3)
  rejection_reason String?   @db.Text

  created_at DateTime @default(now()) @db.Timestamptz(3)
  updated_at DateTime @updatedAt @db.Timestamptz(3)

  staff Staff @relation(fields: [staff_id], references: [id], onDelete: Cascade)

  @@index([staff_id, start_date])
  @@index([status])
  @@map("staff_leaves")
}

model StaffAttendance {
  id          String @id @default(uuid())
  staff_id    String
  business_id String

  date   DateTime         @db.Date
  status AttendanceStatus @default(PRESENT)

  check_in_time  DateTime? @db.Timestamptz(3)
  check_out_time DateTime? @db.Timestamptz(3)

  marked_by      String?
  is_auto_marked Boolean @default(false)
  notes          String? @db.Text

  created_at DateTime @default(now()) @db.Timestamptz(3)

  staff Staff @relation(fields: [staff_id], references: [id], onDelete: Cascade)

  @@unique([staff_id, date])
  @@index([staff_id, date])
  @@index([business_id, date])
  @@map("staff_attendance")
}

model StaffPerformance {
  id       String   @id @default(uuid())
  staff_id String
  month    DateTime @db.Date

  total_bookings          Int
  total_estimated_minutes Int
  total_actual_minutes    Int
  average_efficiency      Float

  on_time_count     Int
  delayed_count     Int
  avg_delay_minutes Float

  created_at DateTime @default(now()) @db.Timestamptz(3)
  updated_at DateTime @updatedAt @db.Timestamptz(3)

  staff Staff @relation(fields: [staff_id], references: [id], onDelete: Cascade)

  @@unique([staff_id, month])
  @@index([staff_id, month])
  @@map("staff_performance")
}

model StaffNotification {
  id       String @id @default(uuid())
  staff_id String

  type    StaffNotificationType
  title   String                @db.VarChar(200)
  message String                @db.Text

  data       Json?   @db.JsonB
  action_url String? @db.VarChar(500)

  is_read Boolean   @default(false)
  read_at DateTime? @db.Timestamptz(3)

  created_at DateTime @default(now()) @db.Timestamptz(3)

  staff Staff @relation(fields: [staff_id], references: [id], onDelete: Cascade)

  @@index([staff_id, created_at])
  @@index([staff_id, is_read])
  @@map("staff_notifications")
}

model Admin {
  id      String @id @default(uuid())
  user_id String @unique

  name       String  @db.VarChar(100)
  avatar_url String? @db.VarChar(500)

  permissions Json? @db.JsonB

  is_active Boolean @default(true)

  created_at    DateTime  @default(now()) @db.Timestamptz(3)
  updated_at    DateTime  @updatedAt @db.Timestamptz(3)
  last_login_at DateTime? @db.Timestamptz(3)

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@map("admins")
}

model PlatformService {
  id String @id @default(uuid())

  name        String       @db.VarChar(200)
  description String?      @db.Text
  category    BusinessType
  service_for ServiceFor

  image_url String? @db.VarChar(500)

  is_active  Boolean @default(true)
  sort_order Int     @default(0)

  created_at DateTime @default(now()) @db.Timestamptz(3)
  updated_at DateTime @updatedAt @db.Timestamptz(3)

  business_offerings BusinessServiceOffering[]

  @@index([category, service_for])
  @@index([is_active])
  @@map("platform_services")
}

model BusinessServiceOffering {
  id                  String @id @default(uuid())
  business_id         String
  platform_service_id String

  price            Int
  discounted_price Int?

  image_url String? @db.VarChar(500)

  is_active   Boolean @default(true)
  is_featured Boolean @default(false)

  booking_count Int @default(0)

  created_at DateTime @default(now()) @db.Timestamptz(3)
  updated_at DateTime @updatedAt @db.Timestamptz(3)

  business         Business        @relation(fields: [business_id], references: [id], onDelete: Cascade)
  platform_service PlatformService @relation(fields: [platform_service_id], references: [id], onDelete: Restrict)
  staff_services   StaffService[]

  @@unique([business_id, platform_service_id])
  @@index([business_id])
  @@index([platform_service_id])
  @@index([business_id, is_active])
  @@map("business_service_offerings")
}

model StaffService {
  id                  String @id @default(uuid())
  staff_id            String
  service_offering_id String

  duration_minutes Int
  is_available     Boolean @default(true)

  created_at DateTime @default(now()) @db.Timestamptz(3)

  staff            Staff                   @relation(fields: [staff_id], references: [id], onDelete: Cascade)
  service_offering BusinessServiceOffering @relation(fields: [service_offering_id], references: [id], onDelete: Cascade)

  @@unique([staff_id, service_offering_id])
  @@index([staff_id])
  @@index([service_offering_id])
  @@map("staff_services")
}

model Booking {
  id String @id @default(uuid())

  booking_number  String @unique @db.VarChar(20)
  idempotency_key String @unique @db.VarChar(100)

  customer_id String
  business_id String
  staff_id    String

  service_date DateTime @db.Date
  queue_number Int

  arrival_window_start DateTime @db.Timestamptz(3)
  arrival_window_end   DateTime @db.Timestamptz(3)
  service_start_time   DateTime @db.Timestamptz(3)
  service_end_time     DateTime @db.Timestamptz(3)

  checked_in_at        DateTime? @db.Timestamptz(3)
  service_started_at   DateTime? @db.Timestamptz(3)
  service_completed_at DateTime? @db.Timestamptz(3)

  service_done_at DateTime? @db.Timestamptz(3)
  service_done_by String?

  estimated_duration Int
  actual_duration    Int?

  services Json @db.JsonB

  total_duration Int

  service_amount Int
  platform_fee   Int
  total_amount   Int

  payment_confirmed_at DateTime? @db.Timestamptz(3)

  transaction Transaction?

  status BookingStatus @default(PENDING_PAYMENT)

  cancelled_at        DateTime? @db.Timestamptz(3)
  cancelled_by        String?
  cancellation_reason String?   @db.Text

  notes String? @db.Text

  version Int @default(1)

  created_at DateTime @default(now()) @db.Timestamptz(3)
  updated_at DateTime @updatedAt @db.Timestamptz(3)

  customer Customer @relation(fields: [customer_id], references: [id], onDelete: Restrict)
  business Business @relation(fields: [business_id], references: [id], onDelete: Restrict)
  staff    Staff    @relation(fields: [staff_id], references: [id], onDelete: Restrict)

  events  BookingEvent[]
  qr_code QRCode?
  escrow  EscrowTransaction?
  review  Review?

  @@unique([staff_id, service_date, queue_number], name: "unique_queue_position")
  @@index([customer_id, created_at])
  @@index([staff_id, service_date])
  @@index([business_id, service_date])
  @@index([status])
  @@index([booking_number])
  @@index([idempotency_key])
  @@map("bookings")
}

model DailyQueue {
  id           String   @id @default(uuid())
  staff_id     String
  service_date DateTime @db.Date

  queue_data        Json @default("[]") @db.JsonB
  last_queue_number Int  @default(0)

  version Int @default(1)

  created_at DateTime @default(now()) @db.Timestamptz(3)
  updated_at DateTime @updatedAt @db.Timestamptz(3)

  staff Staff @relation(fields: [staff_id], references: [id], onDelete: Cascade)

  @@unique([staff_id, service_date])
  @@index([staff_id, service_date])
  @@map("daily_queues")
}

model BookingEvent {
  id         String @id @default(uuid())
  booking_id String

  event_type   BookingEventType
  event_data   Json             @db.JsonB
  triggered_by String?

  created_at DateTime @default(now()) @db.Timestamptz(3)

  booking Booking @relation(fields: [booking_id], references: [id], onDelete: Cascade)

  @@index([booking_id, created_at])
  @@index([event_type])
  @@map("booking_events")
}

model QRCode {
  id         String @id @default(uuid())
  booking_id String @unique

  qr_code_id   String @unique @db.VarChar(50)
  qr_data      String @db.Text
  qr_image_url String @db.Text

  is_used       Boolean   @default(false)
  used_at       DateTime? @db.Timestamptz(3)
  used_by_staff String?

  expires_at DateTime @db.Timestamptz(3)

  created_at DateTime @default(now()) @db.Timestamptz(3)

  booking Booking @relation(fields: [booking_id], references: [id], onDelete: Cascade)

  @@index([qr_code_id])
  @@index([is_used])
  @@index([expires_at])
  @@map("qr_codes")
}

model Transaction {
  id String @id @default(uuid())

  booking_id  String @unique
  customer_id String
  business_id String
  staff_id    String

  razorpay_order_id   String  @unique @db.VarChar(100)
  razorpay_payment_id String? @unique @db.VarChar(100)
  razorpay_signature  String? @db.VarChar(500)

  amount         Int
  currency       String  @default("INR") @db.VarChar(3)
  payment_method String? @db.VarChar(50)

  status TransactionStatus @default(PENDING)

  created_at     DateTime  @default(now()) @db.Timestamptz(3)
  paid_at        DateTime? @db.Timestamptz(3)
  failed_at      DateTime? @db.Timestamptz(3)
  failure_reason String?   @db.Text

  refund_id     String?   @db.VarChar(100)
  refund_amount Int?
  refunded_at   DateTime? @db.Timestamptz(3)

  booking  Booking  @relation(fields: [booking_id], references: [id], onDelete: Cascade)
  customer Customer @relation(fields: [customer_id], references: [id], onDelete: Restrict)

  platform_fee PlatformFeeTransaction?
  escrow       EscrowTransaction?

  @@index([status])
  @@index([razorpay_order_id])
  @@index([customer_id, created_at])
  @@index([booking_id])
  @@map("transactions")
}

model PlatformFeeTransaction {
  id             String @id @default(uuid())
  transaction_id String @unique
  booking_id     String
  business_id    String

  amount        Int
  status        String   @default("COLLECTED") @db.VarChar(20)
  collected_at  DateTime @db.Timestamptz(3)
  is_refundable Boolean  @default(false)

  transaction Transaction @relation(fields: [transaction_id], references: [id], onDelete: Cascade)

  @@index([collected_at])
  @@index([business_id])
  @@map("platform_fee_transactions")
}

model EscrowTransaction {
  id             String @id @default(uuid())
  transaction_id String @unique
  booking_id     String @unique
  business_id    String
  staff_id       String

  amount Int
  status EscrowStatus @default(HELD)

  held_at              DateTime  @db.Timestamptz(3)
  scheduled_release_at DateTime  @db.Timestamptz(3)
  released_at          DateTime? @db.Timestamptz(3)
  refunded_at          DateTime? @db.Timestamptz(3)

  transaction Transaction @relation(fields: [transaction_id], references: [id], onDelete: Cascade)
  booking     Booking     @relation(fields: [booking_id], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([scheduled_release_at])
  @@map("escrow_transactions")
}

model Review {
  id          String @id @default(uuid())
  booking_id  String @unique
  customer_id String
  business_id String
  staff_id    String

  staff_rating    Int
  business_rating Int
  overall_rating  Int

  staff_comment    String? @db.Text
  business_comment String? @db.Text

  images Json? @db.JsonB

  is_verified Boolean @default(false)
  is_visible  Boolean @default(true)
  is_edited   Boolean @default(false)

  business_response    String?   @db.Text
  business_response_at DateTime? @db.Timestamptz(3)

  created_at DateTime @default(now()) @db.Timestamptz(3)
  updated_at DateTime @updatedAt @db.Timestamptz(3)

  booking  Booking  @relation(fields: [booking_id], references: [id], onDelete: Cascade)
  customer Customer @relation(fields: [customer_id], references: [id], onDelete: Cascade)
  business Business @relation(fields: [business_id], references: [id], onDelete: Cascade)
  staff    Staff    @relation(fields: [staff_id], references: [id], onDelete: Cascade)

  @@index([business_id, created_at])
  @@index([staff_id, created_at])
  @@index([overall_rating])
  @@map("reviews")
}

model PlatformConfig {
  id String @id @default(uuid())

  key   String @unique @db.VarChar(100)
  value String @db.VarChar(255)

  description String? @db.Text

  updated_by String?

  created_at DateTime @default(now()) @db.Timestamptz(3)
  updated_at DateTime @updatedAt @db.Timestamptz(3)

  @@index([key])
  @@map("platform_configs")
}

model PlatformRevenue {
  id String @id @default(uuid())

  date DateTime @unique @db.Date

  total_bookings      Int @default(0)
  successful_bookings Int @default(0)
  cancelled_bookings  Int @default(0)

  total_revenue   Int @default(0)
  refunded_amount Int @default(0)
  net_revenue     Int @default(0)

  business_breakdown Json? @db.JsonB

  created_at DateTime @default(now()) @db.Timestamptz(3)
  updated_at DateTime @updatedAt @db.Timestamptz(3)

  @@index([date])
  @@map("platform_revenue")
}
